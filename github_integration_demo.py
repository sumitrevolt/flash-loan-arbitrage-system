#!/usr/bin/env python3
"""
Enhanced GitHub Integration Demonstration
=========================================

This script demonstrates all 5 agents actively using the GitHub token
for their specialized operations with real examples.
"""

import asyncio
import json
import os
from datetime import datetime
from github import Github

class GitHubIntegrationDemo:
    """Demonstrate GitHub integration across all agents"""
    
    def __init__(self, github_token: str):
        self.github_token = github_token
        self.github = Github(github_token)
        
    async def run_demo(self):
        """Run comprehensive GitHub integration demonstration"""
        print("üöÄ ENHANCED GITHUB INTEGRATION DEMONSTRATION")
        print("="*80)
        
        try:
            # Verify GitHub connection
            await self._verify_github_connection()
            
            # Demonstrate each agent's GitHub capabilities
            await self._demo_coordinator_github_features()
            await self._demo_indexer_github_features()
            await self._demo_analyzer_github_features()
            await self._demo_executor_github_features()
            await self._demo_guardian_github_features()
            
            # Show multi-agent coordination
            await self._demo_multi_agent_coordination()
            
        except Exception as e:
            print(f"‚ùå Demo failed: {e}")
    
    async def _verify_github_connection(self):
        """Verify GitHub connection and show user info"""
        print("\nüîó VERIFYING GITHUB CONNECTION")
        print("-" * 40)
        
        try:
            user = self.github.get_user()
            print(f"‚úÖ Connected to GitHub as: {user.login}")
            print(f"   Name: {user.name}")
            print(f"   Public Repos: {user.public_repos}")
            print(f"   Followers: {user.followers}")
            print(f"   Following: {user.following}")
            
            # Check rate limit
            rate_limit = self.github.get_rate_limit()
            core_limit = rate_limit.core
            print(f"   API Rate Limit: {core_limit.remaining}/{core_limit.limit}")
            print(f"   Reset Time: {core_limit.reset}")
            
        except Exception as e:
            print(f"‚ùå GitHub connection failed: {e}")
            raise
    
    async def _demo_coordinator_github_features(self):
        """Demonstrate CoordinatorAgent GitHub features"""
        print("\nüéØ COORDINATOR AGENT - GITHUB PROJECT ANALYSIS")
        print("-" * 60)
        
        print("üîç Searching for DeFi coordination projects...")
        
        try:
            # Search for DeFi coordination repositories
            repos = self.github.search_repositories("defi arbitrage coordination", sort="stars")
            
            print("üìä TOP DEFI COORDINATION PROJECTS:")
            for i, repo in enumerate(repos[:5], 1):
                print(f"   {i}. ‚≠ê {repo.full_name} ({repo.stargazers_count} stars)")
                print(f"      üìù {repo.description}")
                print(f"      üîß Language: {repo.language}")
                print(f"      üìÖ Updated: {repo.updated_at.strftime('%Y-%m-%d')}")
                print()
            
            print("‚úÖ CoordinatorAgent can access GitHub project data for coordination")
            
        except Exception as e:
            print(f"‚ùå Coordinator GitHub demo failed: {e}")
    
    async def _demo_indexer_github_features(self):
        """Demonstrate IndexerAgent GitHub features"""
        print("\nüìö INDEXER AGENT - PROTOCOL REPOSITORY INDEXING")
        print("-" * 60)
        
        print("üîç Indexing major DeFi protocol repositories...")
        
        try:
            protocols = {
                "Uniswap": "Uniswap/v3-core",
                "Aave": "aave/aave-v3-core", 
                "Compound": "compound-finance/compound-protocol",
                "SushiSwap": "sushiswap/sushiswap"
            }
            
            protocol_data = {}
            
            for protocol_name, repo_name in protocols.items():
                try:
                    repo = self.github.get_repo(repo_name)
                    
                    # Get contract files
                    contracts = []
                    try:
                        contents = repo.get_contents("contracts")
                        if isinstance(contents, list):
                            for item in contents[:5]:
                                if item.name.endswith('.sol'):
                                    contracts.append(item.name)
                    except:
                        pass
                    
                    protocol_data[protocol_name] = {
                        "repository": repo.full_name,
                        "stars": repo.stargazers_count,
                        "forks": repo.forks_count,
                        "language": repo.language,
                        "updated": repo.updated_at.strftime('%Y-%m-%d'),
                        "contracts": contracts[:5]
                    }
                    
                    print(f"üì¶ {protocol_name}:")
                    print(f"   Repository: {repo.full_name}")
                    print(f"   ‚≠ê Stars: {repo.stargazers_count}")
                    print(f"   üç¥ Forks: {repo.forks_count}")
                    print(f"   üìÑ Smart Contracts: {len(contracts)}")
                    if contracts:
                        print(f"   üîß Sample Contracts: {', '.join(contracts[:3])}...")
                    print()
                    
                except Exception as e:
                    print(f"   ‚ùå Failed to index {protocol_name}: {e}")
            
            print("‚úÖ IndexerAgent can systematically index DeFi protocols from GitHub")
            
        except Exception as e:
            print(f"‚ùå Indexer GitHub demo failed: {e}")
    
    async def _demo_analyzer_github_features(self):
        """Demonstrate AnalyzerAgent GitHub features"""
        print("\nüìä ANALYZER AGENT - SMART CONTRACT CODE ANALYSIS")
        print("-" * 60)
        
        print("üîç Analyzing arbitrage-related smart contract code...")
        
        try:
            # Search for arbitrage smart contracts
            code_results = self.github.search_code("flashloan arbitrage language:solidity")
            
            print("üí∞ ARBITRAGE SMART CONTRACT ANALYSIS:")
            
            analysis_results = []
            for i, code in enumerate(code_results[:5], 1):
                repo_info = {
                    "file": f"{code.repository.full_name}/{code.path}",
                    "repository": code.repository.full_name,
                    "description": code.repository.description,
                    "stars": code.repository.stargazers_count,
                    "language": code.repository.language
                }
                analysis_results.append(repo_info)
                
                print(f"   {i}. üìÑ {code.repository.full_name}/{code.name}")
                print(f"      ‚≠ê Repository: {code.repository.full_name} ({code.repository.stargazers_count} stars)")
                print(f"      üìù Description: {code.repository.description}")
                print(f"      üîß Language: {code.repository.language}")
                print()
            
            print("üß† ANALYSIS INSIGHTS:")
            total_stars = sum(r['stars'] for r in analysis_results)
            avg_stars = total_stars / len(analysis_results) if analysis_results else 0
            print(f"   ‚Ä¢ Found {len(analysis_results)} arbitrage implementations")
            print(f"   ‚Ä¢ Average repository popularity: {avg_stars:.0f} stars")
            print(f"   ‚Ä¢ Primary language: Solidity")
            print(f"   ‚Ä¢ Analysis confidence: High")
            
            print("‚úÖ AnalyzerAgent can analyze smart contract code from GitHub")
            
        except Exception as e:
            print(f"‚ùå Analyzer GitHub demo failed: {e}")
    
    async def _demo_executor_github_features(self):
        """Demonstrate ExecutorAgent GitHub features"""
        print("\n‚ö° EXECUTOR AGENT - CONTRACT VERIFICATION")
        print("-" * 60)
        
        print("üîç Verifying smart contracts before execution...")
        
        try:
            # Analyze Uniswap V3 contracts for execution
            repo = self.github.get_repo("Uniswap/v3-core")
            
            print("üîí CONTRACT VERIFICATION RESULTS:")
            print(f"   Repository: {repo.full_name}")
            print(f"   ‚≠ê Trust Score: {repo.stargazers_count} stars (High Trust)")
            print(f"   üç¥ Community: {repo.forks_count} forks")
            print(f"   üìÖ Last Updated: {repo.updated_at.strftime('%Y-%m-%d')}")
            print(f"   üè¢ Owner: {repo.owner.login}")
            print(f"   üìä Open Issues: {repo.open_issues_count}")
            
            # Check for security-related files
            security_indicators = []
            try:
                contents = repo.get_contents("")
                for item in contents:
                    if any(keyword in item.name.lower() for keyword in ['security', 'audit', 'test']):
                        security_indicators.append(item.name)
            except:
                pass
            
            print(f"   üõ°Ô∏è  Security Files: {len(security_indicators)}")
            if security_indicators:
                print(f"      ‚Ä¢ {', '.join(security_indicators[:3])}...")
            
            # Get recent commits
            commits = list(repo.get_commits()[:3])
            print(f"   üìà Recent Activity: {len(commits)} commits")
            for commit in commits:
                print(f"      ‚Ä¢ {commit.commit.message[:50]}... ({commit.commit.author.date.strftime('%Y-%m-%d')})")
            
            verification_score = min(repo.stargazers_count / 1000, 10)  # Max 10
            print(f"   ‚úÖ Verification Score: {verification_score:.1f}/10.0")
            
            if verification_score > 5:
                print("   üü¢ SAFE FOR EXECUTION")
            else:
                print("   üü° REQUIRES ADDITIONAL VERIFICATION")
            
            print("‚úÖ ExecutorAgent can verify contracts through GitHub analysis")
            
        except Exception as e:
            print(f"‚ùå Executor GitHub demo failed: {e}")
    
    async def _demo_guardian_github_features(self):
        """Demonstrate GuardianAgent GitHub features"""
        print("\nüõ°Ô∏è  GUARDIAN AGENT - SECURITY VULNERABILITY SCANNING")
        print("-" * 60)
        
        print("üîç Scanning for security vulnerabilities in DeFi projects...")
        
        try:
            # Search for security-related repositories
            security_repos = self.github.search_repositories("defi security audit vulnerability")
            
            print("üîí SECURITY ANALYSIS RESULTS:")
            
            vulnerability_data = []
            for i, repo in enumerate(security_repos[:4], 1):
                
                # Analyze repository for security indicators
                security_score = 0
                
                # Check repository metrics
                if repo.stargazers_count > 100:
                    security_score += 2
                if repo.forks_count > 50:
                    security_score += 1
                if repo.open_issues_count < 10:
                    security_score += 1
                
                # Check for security-related content
                security_files = []
                try:
                    contents = repo.get_contents("")
                    for item in contents:
                        if any(keyword in item.name.lower() for keyword in ['security', 'audit', 'vulnerability', 'safe']):
                            security_files.append(item.name)
                            security_score += 1
                except:
                    pass
                
                vulnerability_data.append({
                    "repo": repo.full_name,
                    "security_score": min(security_score, 10),
                    "security_files": security_files
                })
                
                print(f"   {i}. üîç {repo.full_name}")
                print(f"      ‚≠ê Stars: {repo.stargazers_count}")
                print(f"      üîß Language: {repo.language}")
                print(f"      üìù {repo.description}")
                print(f"      üõ°Ô∏è  Security Score: {min(security_score, 10)}/10")
                if security_files:
                    print(f"      üìÑ Security Files: {', '.join(security_files[:2])}...")
                print()
            
            # Security summary
            avg_security_score = sum(v['security_score'] for v in vulnerability_data) / len(vulnerability_data)
            print(f"üìä SECURITY SUMMARY:")
            print(f"   ‚Ä¢ Repositories Analyzed: {len(vulnerability_data)}")
            print(f"   ‚Ä¢ Average Security Score: {avg_security_score:.1f}/10")
            print(f"   ‚Ä¢ High Security Repos: {sum(1 for v in vulnerability_data if v['security_score'] >= 7)}")
            print(f"   ‚Ä¢ Requires Review: {sum(1 for v in vulnerability_data if v['security_score'] < 7)}")
            
            print("‚úÖ GuardianAgent can scan GitHub for security vulnerabilities")
            
        except Exception as e:
            print(f"‚ùå Guardian GitHub demo failed: {e}")
    
    async def _demo_multi_agent_coordination(self):
        """Demonstrate multi-agent coordination using GitHub data"""
        print("\nü§ù MULTI-AGENT COORDINATION WITH GITHUB DATA")
        print("-" * 60)
        
        print("üéØ Simulating coordinated DeFi arbitrage analysis...")
        
        try:
            # Simulate a coordinated workflow
            workflow_steps = [
                "1. üìö IndexerAgent: Index Uniswap V3 protocol from GitHub",
                "2. üìä AnalyzerAgent: Analyze arbitrage opportunities in indexed code",
                "3. ‚ö° ExecutorAgent: Verify contracts for safe execution",
                "4. üõ°Ô∏è  GuardianAgent: Perform security scan on execution plan",
                "5. üéØ CoordinatorAgent: Orchestrate final execution strategy"
            ]
            
            print("üîÑ COORDINATION WORKFLOW:")
            for step in workflow_steps:
                print(f"   {step}")
                await asyncio.sleep(0.5)  # Simulate processing
            
            # Simulate coordination results
            coordination_results = {
                "protocols_indexed": 4,
                "arbitrage_opportunities": 12,
                "contracts_verified": 8,
                "security_issues": 1,
                "recommended_actions": 3,
                "estimated_profit": "$2,500",
                "risk_level": "Medium",
                "execution_confidence": "85%"
            }
            
            print("\nüìä COORDINATION RESULTS:")
            for key, value in coordination_results.items():
                formatted_key = key.replace('_', ' ').title()
                print(f"   ‚Ä¢ {formatted_key}: {value}")
            
            print("\nüéâ MULTI-AGENT COORDINATION SUCCESSFUL!")
            print("   All agents successfully used GitHub token for specialized operations")
            
        except Exception as e:
            print(f"‚ùå Multi-agent coordination demo failed: {e}")

async def interactive_demo():
    """Interactive demonstration mode"""
    print("\nüí¨ INTERACTIVE GITHUB INTEGRATION DEMO")
    print("="*80)
    
    github_token = os.getenv("GITHUB_TOKEN")
    if not github_token:
        github_token = input("Enter your GitHub token: ").strip()
        if not github_token:
            print("‚ùå GitHub token required")
            return
    
    demo = GitHubIntegrationDemo(github_token)
    
    while True:
        print("\nüéØ AVAILABLE DEMONSTRATIONS:")
        print("1. üîó Verify GitHub Connection")
        print("2. üéØ Coordinator GitHub Features")
        print("3. üìö Indexer GitHub Features")
        print("4. üìä Analyzer GitHub Features")
        print("5. ‚ö° Executor GitHub Features")
        print("6. üõ°Ô∏è  Guardian GitHub Features")
        print("7. ü§ù Multi-Agent Coordination")
        print("8. üöÄ Full Demo Suite")
        print("9. ‚ùå Exit")
        
        choice = input("\nSelect demo (1-9): ").strip()
        
        try:
            if choice == "1":
                await demo._verify_github_connection()
            elif choice == "2":
                await demo._demo_coordinator_github_features()
            elif choice == "3":
                await demo._demo_indexer_github_features()
            elif choice == "4":
                await demo._demo_analyzer_github_features()
            elif choice == "5":
                await demo._demo_executor_github_features()
            elif choice == "6":
                await demo._demo_guardian_github_features()
            elif choice == "7":
                await demo._demo_multi_agent_coordination()
            elif choice == "8":
                await demo.run_demo()
            elif choice == "9":
                print("üëã Goodbye!")
                break
            else:
                print("‚ùå Invalid choice. Please select 1-9.")
        except Exception as e:
            print(f"‚ùå Demo error: {e}")

async def main():
    """Main execution"""
    print("üöÄ ENHANCED GITHUB INTEGRATION DEMONSTRATION")
    print("="*80)
    print("This demo shows all 5 agents actively using GitHub token:")
    print("‚Ä¢ CoordinatorAgent: Project analysis and coordination")
    print("‚Ä¢ IndexerAgent: Protocol repository indexing")
    print("‚Ä¢ AnalyzerAgent: Smart contract code analysis")
    print("‚Ä¢ ExecutorAgent: Contract verification")
    print("‚Ä¢ GuardianAgent: Security vulnerability scanning")
    
    mode = input("\nRun [F]ull demo or [I]nteractive mode? (F/I): ").strip().upper()
    
    if mode == "I":
        await interactive_demo()
    else:
        # Full demo mode
        github_token = os.getenv("GITHUB_TOKEN")
        if not github_token:
            github_token = input("Enter your GitHub token: ").strip()
            if not github_token:
                print("‚ùå GitHub token required")
                return
        
        demo = GitHubIntegrationDemo(github_token)
        await demo.run_demo()

if __name__ == "__main__":
    asyncio.run(main())
